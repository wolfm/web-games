<!DOCTYPE HTML>

<html>
    <head>
        <title>Socket Game</title>
        <style>
            * { padding: 0; margin: 0; }
            canvas { 
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #eee;
            }
        </style>
    </head>
    <body>
        <canvas id="myCanvas" width="480" height="320"></canvas>
        <script type="text/javascript">

            var state = {players: {}}

            function draw() {
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw all players
                for (var player_id in state.players) {
                    // Draw a circle
                    // console.log(state.players[player_id])
                    ctx.beginPath();
                    ctx.arc(state.players[player_id].x, state.players[player_id].y, 20, 0, Math.PI*2, false);
                    ctx.fillStyle = state.players[player_id].color;
                    ctx.fill();
                    ctx.closePath();
                }
            }

            // Key Press handlers
            leftPressed = false
            rightPressed = false
            upPressed = false
            downPressed = false
            function keyDownHandler(e) {
                if(e.key == "Left" || e.key == "ArrowLeft") {
                    leftPressed = true;
                }
                if(e.key == "Right" || e.key == "ArrowRight") {
                    rightPressed = true;
                }
                if(e.key == "Up" || e.key == "ArrowUp") {
                    upPressed = true;
                }
                if(e.key == "Down" || e.key == "ArrowDown") {
                    downPressed = true;
                }
            }
            function keyUpHandler(e) {
                if(e.key == "Left" || e.key == "ArrowLeft") {
                    leftPressed = false;
                }
                if(e.key == "Right" || e.key == "ArrowRight") {
                    rightPressed = false;
                }
                if(e.key == "Up" || e.key == "ArrowUp") {
                    upPressed = false;
                }
                if(e.key == "Down" || e.key == "ArrowDown") {
                    downPressed = false;
                }
            }

            // Setup Canvas
            var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");

            // Setup keyboard controls
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);
            
            // Connect to server
            if("WebSocket" in window) {
                // Open a new websocket
                var ws = new WebSocket("ws://192.168.1.129:8080/echo")

                // Callback for messages from server
                ws.onmessage = function(event) {
                    // console.log(event.data)
                    state.players = JSON.parse(event.data).players
                    console.log(state)
                    // draw()
                }

                ws.onclose = function() {
                    console.log("Connection closed")
                }

                function gameLoop() {
                    if(leftPressed) {
                        console.log("Left")
                        ws.send(JSON.stringify({command: "left"}))
                    }
                    if(rightPressed) {
                        console.log("Right")
                        ws.send(JSON.stringify({command: "right"}))
                    }
                    if(upPressed) {
                        console.log("Up")
                        ws.send(JSON.stringify({command: "up"}))
                    }
                    if(downPressed) {
                        console.log("Down")
                        ws.send(JSON.stringify({command: "down"}))
                    }
                    draw();
                }

                setInterval(gameLoop, 10)

            } else {
                console.log("WebSocket is NOT supported by this browser!")
            }

        </script>
    </body>
</html>
